<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Don't Touch The Floor!</title>
  <!-- Google font link for Press Start 2P -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
  <style>
    /* Use the "Press Start 2P" font for a blocky/retro style */ 
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Bungee', sans-serif;
      text-align: center;
      background: #000;
    }
    /* Add a thin black outline around all/* Add a thin black outline around all text */
body, h1, h2, h3, h4, h5, h6, p, span, div {
    text-shadow: 
        -1px -1px 0 #000,  
         1px -1px 0 #000,
        -1px  1px 0 #000,
         1px  1px 0 #000;
} text */
    body, h1, h2, h3, h4, h5, h6, p, span, div {
      text-shadow: 
        -1px -1px 0 #000,  
         1px -1px 0 #000,
        -1px  1px 0 #000,
         1px  1px 0 #000;
    }

    #appContainer {
      position: relative;
      width: 100%;
      height: 100%;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      overflow: hidden;
      background-size: cover;    /* Fill background images */
      background-position: center;
      background-repeat: no-repeat;
    }

    .title {
      font-size: 2.4em; /* Because Press Start 2P is quite small by default */
      margin-bottom: 20px;
      line-height: 1.3;
    }

    .mode-text {
      font-size: 2em;
      line-height: 1.2;
      margin: 20px;
    }

    .play-button, .end-button {
      background: rgba(0,0,0,0.7);
      border: none;
      padding: 1em 2em;
      color: #fff;
      font-size: 0.9em;
      cursor: pointer;
      border-radius: 8px;
      margin-top: 10px;
    }
    .play-button:hover, .end-button:hover {
      background: rgba(0,0,0,0.9);
    }

    .end-button {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 0.8em;
      z-index: 999;
    }

    .get-ready-text {
      font-size: 1.2em;
      line-height: 1.4;
    }
  </style>
</head>
<body>

<!-- Background music file (looped) -->
<audio id="backgroundMusic" src="floorbackground.mp3" loop></audio>

<div id="appContainer"></div>

<script>
  // -- GLOBALS --
  let isGameRunning = false;
  let activeTimeouts = [];
  let audioContext = null;           // For the "DING DING" beep
  let lastModeIndex = -1;            // Track the last mode index shown

  // We'll handle background music and override music
  const backgroundMusic = document.getElementById('backgroundMusic');
  let overrideMusic = null; // We'll dynamically create a new Audio() if needed

  const preloadImages = () => {
    modes.forEach(mode => {
        if (mode.backgroundImage) {
            const img = new Image();
            img.src = mode.backgroundImage;
        }
    });
};

// Call preload function when the script runs
preloadImages();

  // Define modes with per-mode weighting ("weight").
  // Higher weight => more likely to appear.
  const modes = [
    {
      name: 'HAND MODE',
      color: '#FF3333',
      backgroundImage: 'handmode.png',
      overrideMusicUrl: '',
      minDuration: 15000,
      maxDuration: 25000,
      weight: 5    // More likely
    },
    {
      name: 'KICK MODE',
      color: '#33CC33',
      backgroundImage: 'kickmode.png',
      overrideMusicUrl: '',
      minDuration: 15000,
      maxDuration: 25000,
      weight: 5
    },
    {
      name: 'BAT MODE',
      color: '#3333FF',
      backgroundImage: 'batmode.png',
      overrideMusicUrl: '',
      minDuration: 20000,
      maxDuration: 21000,
      weight: 5    // More likely
    },
    {
      name: 'HEAD MODE',
      color: '#FF9900',
      backgroundImage: 'headmode.png',
      overrideMusicUrl: '',
      minDuration: 1000,
      maxDuration: 2000,
      weight: 2
    },
    {
      name: 'BED MODE',
      color: '#663399',
      backgroundImage: 'bedmode.png',
      overrideMusicUrl: 'bedmode.mp3',
      minDuration: 10000,
      maxDuration: 12000,
      weight: 4    // More likely
    },
    {
      name: 'ELBOW MODE',
      color: '#CC33CC',
      backgroundImage: 'elbowmode.png',
      overrideMusicUrl: '',
      minDuration: 1000,
      maxDuration: 2000,
      weight: 1
    },
    {
      name: 'NOSE MODE',
      color: '#FFA500',
      backgroundImage: 'nosemode.png',
      overrideMusicUrl: 'nosemode.mp3',
      minDuration: 10000,
      maxDuration: 11000,
      weight: 2    // Least likely
    }
  ];

  const appContainer = document.getElementById('appContainer');

  // -- HELPER: Clear all active timeouts --
  function clearAllTimeouts() {
    activeTimeouts.forEach(id => clearTimeout(id));
    activeTimeouts = [];
  }

  // -- HELPER: Get random duration for a particular mode
  function getModeDuration(mode) {
    const minMs = mode.minDuration;
    const maxMs = mode.maxDuration;
    return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
  }

  // -- HELPER: Weighted random pick of a mode, skipping last mode if possible.
  function pickWeightedMode() {
    // If there's more than one mode, skip the last mode index in the weighted pool.
    let candidateModes = modes.map((m, idx) => ({ ...m, idx }));
    if (lastModeIndex !== -1 && modes.length > 1) {
      candidateModes = candidateModes.filter(({ idx }) => idx !== lastModeIndex);
    }

    // Calculate total weight
    const totalWeight = candidateModes.reduce((acc, m) => acc + (m.weight || 1), 0);
    // Pick random from 0..totalWeight
    let rnd = Math.random() * totalWeight;

    // Find which mode we land on
    for (const m of candidateModes) {
      const w = m.weight || 1;
      if (rnd < w) {
        return m; // Return the chosen mode object (with .idx)
      }
      rnd -= w;
    }
    // Fallback: if something goes off, just return the last in the array
    return candidateModes[candidateModes.length - 1];
  }

  // -- HELPER: Show home screen (opening page) --
  function showHomeScreen() {
    // Stop any music if it's playing
    backgroundMusic.pause();
    backgroundMusic.currentTime = 0;
    if (overrideMusic) {
      overrideMusic.pause();
      overrideMusic = null;
    }

    appContainer.style.backgroundColor = '#FF00AA'; // Some bright color
    appContainer.style.backgroundImage = 'none';    // Remove any leftover image
    appContainer.innerHTML = `
      <div class="title">Don't Touch The Floor! - Ada - v0.1</div>
      <button class="play-button" onclick="startGame()">PLAY</button>
    `;
  }

  // -- HELPER: Show "GET READY!" screen for 1s (adjust if you like)
  function showGetReadyScreen(callback) {
    appContainer.style.backgroundColor = '#000000';
    appContainer.style.backgroundImage = 'none';
    appContainer.innerHTML = `
      <button class="end-button" onclick="endGame()">END GAME</button>
      <div class="get-ready-text">GET READY!</div>
    `;
    // After 1 second, call the callback
    const t = setTimeout(callback, 4000);
    activeTimeouts.push(t);
  }

  // -- HELPER: Show a mode screen and hold it for random duration
  function showModeScreen() {
    if (!isGameRunning) return;

    const chosenMode = pickWeightedMode();
    lastModeIndex = chosenMode.idx; // Track which index we used

    // 1) Set the background
    if (chosenMode.backgroundImage) {
      appContainer.style.backgroundImage = `url('${chosenMode.backgroundImage}')`;
      appContainer.style.backgroundColor = 'transparent';
    } else {
      appContainer.style.backgroundImage = 'none';
      appContainer.style.backgroundColor = chosenMode.color;
    }

    // 2) Play "DING DING" beep
    playDingDing();

    // 3) If this mode has override music, pause main music, play override
    if (chosenMode.overrideMusicUrl) {
      backgroundMusic.pause();
      overrideMusic = new Audio(chosenMode.overrideMusicUrl);
      overrideMusic.play().catch(err => {
        console.warn("Could not play override music:", err);
      });
    } else {
      // Resume the background music if it's paused
      if (backgroundMusic.paused) {
        backgroundMusic.play().catch(err => {
          console.warn("Could not resume background music:", err);
        });
      }
    }

    // 4) Render mode text
    appContainer.innerHTML = `
      <button class="end-button" onclick="endGame()">END GAME</button>
      <div class="mode-text">${chosenMode.name}</div>
    `;

    // 5) Stay in this mode for a random time (unique to that mode)
    const duration = getModeDuration(chosenMode);
    const t = setTimeout(() => {
      if (isGameRunning) {
        // If override music was playing, stop it
        if (overrideMusic && !overrideMusic.paused) {
          overrideMusic.pause();
          overrideMusic = null;
        }
        // Resume main music after override
        if (backgroundMusic.paused) {
          backgroundMusic.play().catch(err => {
            console.warn("Could not resume background music:", err);
          });
        }
        // Move to "GET READY!" then pick next mode
        showGetReadyScreen(showModeScreen);
      }
    }, duration);
    activeTimeouts.push(t);
  }

  // -- MAIN CYCLE: show "GET READY!" then show the mode, repeat...
  function cycleModes() {
    showGetReadyScreen(showModeScreen);
  }

  // -- START the game --
  function startGame() {
    if (!audioContext) {
      // Must be triggered by user action to comply with browser audio policies
      audioContext = new AudioContext();
    }
    clearAllTimeouts();
    isGameRunning = true;

    // Start background music
    backgroundMusic.currentTime = 0;
    backgroundMusic.volume = 1.0;
    backgroundMusic.play().catch(err => {
      console.warn("Could not start background music:", err);
    });

    cycleModes();
  }

  // -- END the game --
  function endGame() {
    isGameRunning = false;
    clearAllTimeouts();

    // If override music is playing, stop it
    if (overrideMusic) {
      overrideMusic.pause();
      overrideMusic = null;
    }

    showHomeScreen();
  }

  // -- AUDIO: "DING DING" using the Web Audio API --
  function playDingDing() {
    if (!audioContext) return;

    const now = audioContext.currentTime;
    let beepStart = now;

    for (let i = 0; i < 2; i++) {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.frequency.value = 880; // A5 note
      oscillator.type = 'sine';

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.start(beepStart);
      oscillator.stop(beepStart + 0.2);

      // Each beep begins 0.3s after the previous beep's start
      beepStart += 0.3;
    }
  }

  // Show the home screen immediately on load
  showHomeScreen();
</script>

</body>
</html>